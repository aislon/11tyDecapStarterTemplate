<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://aislon-cdn.pages.dev https://identity.netlify.com; style-src 'self' 'unsafe-inline';" />
    
    <title>Aislon Web Manager</title>
    
    <style>
      :root {
        --primary-color: rgb(58, 105, 199);
        --secondary-color: #f5f5f5;
        --hover-color: #e9e9e9;
        --text-color: #000;
      }
      
      .persistent-button {
        width: 100%;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        font-size: 14px;
        color: var(--text-color);
        text-decoration: none;
        background-color: var(--secondary-color);
        border-radius: 6px;
        transition: background-color 0.2s ease;
        height: 100%;
      }
      
      .persistent-button:hover {
        background-color: var(--hover-color);
      }
      
      .persistent-button:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body>
    <noscript>
      <div style="color: red; padding: 20px;">
        JavaScript is required to use the Aislon Web Manager. Please enable JavaScript in your browser.
      </div>
    </noscript>

    <script src="https://aislon-cdn.pages.dev/cms/latest/aislon-decap-cms.js"></script> 
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
    // Configuration Object
    const AISLON_CONFIG = {
      debug: false,
      urls: {
        analytics: '/analytics',
        siteInfo: '/site-info'
      },
      paths: {
        analyticsIcon: '/admin/media/analytic.svg',
        infoIcon: '/admin/media/info.svg',
        avatarIcon: '/admin/media/aislonHat.png'
      },
      selectors: {
        sidebarNav: '.css-kxvohc-SidebarNavList',
        avatarIcon: '.css-16ibyj6-IconWrapper-AvatarPlaceholderIcon-avatarImage'
      }
    };

    // Utility Functions
    const log = (message, type = 'log') => {
      if (AISLON_CONFIG.debug) {
        console[type](`[Aislon CMS]: ${message}`);
      }
    };

    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    };

    const sanitizeHTML = (str) => {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    };

    // Netlify Identity Management
    const setupNetlifyIdentity = () => {
      if (!window.netlifyIdentity) {
        log('Netlify Identity not loaded', 'error');
        return;
      }

      window.netlifyIdentity.on("init", user => {
        log(`User initialization: ${user ? user.email : 'Not logged in'}`);
      });

      window.netlifyIdentity.on("login", () => {
        log('Login successful');
        window.location.href = "/admin/#/";
      });

      window.netlifyIdentity.on("logout", () => {
        log('Logout successful');
        window.location.href = "/";
      });

      window.netlifyIdentity.on("error", err => {
        log(`Identity error: ${err}`, 'error');
      });
    };

    // Custom Buttons Creation
    const createCustomButtons = () => {
      const customSection = document.createElement('div');
      customSection.id = 'custom-section';
      Object.assign(customSection.style, {
        marginTop: '8px',
        marginBottom: '8px',
        paddingBottom: '8px',
        width: '100%',
        display: 'flex'
      });

      const customNav = document.createElement('ul');
      customNav.className = 'css-kxvohc-SidebarNavList persistent-nav';
      Object.assign(customNav.style, {
        width: '100%',
        display: 'flex',
        gap: '8px',
        padding: '0 12px',
        margin: '0',
        listStyle: 'none'
      });

      const buttonConfigs = [
        {
          url: AISLON_CONFIG.urls.analytics,
          icon: AISLON_CONFIG.paths.analyticsIcon,
          text: 'Analytics',
          ariaLabel: 'Open Analytics Dashboard'
        },
        {
          url: AISLON_CONFIG.urls.siteInfo,
          icon: AISLON_CONFIG.paths.infoIcon,
          text: 'Site Info',
          ariaLabel: 'View Site Information'
        }
      ];

      buttonConfigs.forEach(config => {
        const button = document.createElement('li');
        button.style.flex = '1';
        button.innerHTML = `
          <a 
            href="${sanitizeHTML(config.url)}" 
            class="persistent-button" 
            aria-label="${sanitizeHTML(config.ariaLabel)}"
          >
            <span class="e1jeq5dr0 css-5nxuzj-IconWrapper" style="margin-right: 8px;">
              <img src="${sanitizeHTML(config.icon)}" width="24" height="24" alt="" />
            </span>
            <span style="flex: 1;">${sanitizeHTML(config.text)}</span>
          </a>`;
        
        customNav.appendChild(button);
      });

      customSection.appendChild(customNav);
      return customSection;
    };

    // Persistent Injection Management
    const setupPersistentButtonInjection = () => {
      const debouncedInject = debounce(() => {
        const sidebarNav = document.querySelector(AISLON_CONFIG.selectors.sidebarNav);
        const existingNav = document.querySelector('.persistent-nav');
        
        if (sidebarNav && !existingNav) {
          const customSection = createCustomButtons();
          try {
            sidebarNav.parentNode.insertBefore(customSection, sidebarNav.parentNode.firstChild);
            log('Custom buttons successfully injected');
          } catch (error) {
            log(`Injection failed: ${error}`, 'error');
          }
        }
      }, 250);

      const observer = new MutationObserver(debouncedInject);
      observer.observe(document.body, { 
        childList: true, 
        subtree: true 
      });
    };

    // Avatar Replacement
    const replaceAvatarIcon = () => {
      const debouncedReplace = debounce(() => {
        const iconWrapper = document.querySelector(AISLON_CONFIG.selectors.avatarIcon);
        if (iconWrapper) {
          try {
            const img = document.createElement("img");
            img.src = AISLON_CONFIG.paths.avatarIcon;
            img.width = 22;
            img.height = 22;
            img.alt = "Aislon Avatar";
            Object.assign(img.style, {
              margin: "auto",
              display: "block"
            });

            Object.assign(iconWrapper.style, {
              display: "flex",
              justifyContent: "center",
              alignItems: "center"
            });

            iconWrapper.innerHTML = "";
            iconWrapper.appendChild(img);
            log('Avatar icon replaced successfully');
          } catch (error) {
            log(`Avatar replacement failed: ${error}`, 'error');
          }
        }
      }, 250);

      const observer = new MutationObserver(debouncedReplace);
      observer.observe(document.body, { 
        childList: true, 
        subtree: true 
      });
    };

    // Initialize App
    document.addEventListener("DOMContentLoaded", () => {
      setupNetlifyIdentity();
      setupPersistentButtonInjection();
      replaceAvatarIcon();
    });
    </script>

    <style>
    @media (max-width: 799px) {
      /* Bring Any Dropdown To Center Of Page */
      [class*=DropdownList] {
        position: fixed !important;
        min-width: 20% !important;
        width: 90% !important;
        margin: auto !important;
        height: fit-content !important;
        top: auto !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 10px !important;
        background: #e6f4fd !important;
        border: 2px solid #3a69c7 !important;
      }
      /* Add Overflow To Modal Window */
      [class*=StyledModal]{
        width: 90dvw;
        width: 90%;
      }
      [class*=LibraryTitle]{
        display: none;
      }
      [class*=CollectionTopNewButton]{
        padding: 0px 10px !important;
        height: auto;
      }
      [class*=LibraryTop]{
        overflow-x: auto;
        height: fit-content;
        padding-bottom: 10px;
      }
      /* Hide Blog Post Title From Navbar */
      [class*=BackCollection]{
        display: none;
      }
      /* Add Padding To Control Pane */
      [class*=ControlPaneContainer] {
        padding: 0px 10px;
      }
      /* Rest As Per: Searl's Code*/
      [class*=BackCollection], [class*=BackStatus] {
        font-size: .6rem;
      }
      [class*=AppHeaderContent], [class*=AppMainContainer] {
        margin-right: 0;
        margin-left: 0;
        min-width: calc(100vw - 24px);
        max-width: 100vw;
      }
      [class*=AppHeaderContent] {
        display: flex;
        justify-content: space-between;
      }
      [class*=AppHeaderQuickNewButton] {
        width: 100%;
      }
      [class*=AppHeaderButton] {
        padding-left: 4px;
        padding-right: 4px;
      }
      [class*=EditorContainer], [class*=ToolbarContainer] {
        min-width: initial;
        overflow-x: auto;
      }
      [class*=ToolbarSubSectionFirst] {
        display: flex;
        flex-direction: column;
      }
      [class*=PublishedToolbarButton] {
        padding: 0 8px;
      }
      [class*=PublishedToolbarButton]::after {
        display: none;
      }
      [class*=ToolbarSubSectionFirst] {
        flex-direction: row;
      }
      [class*=SearchInput] {
        margin-top: 5px;
      }
      [class*=ViewControls] {
        position: initial;
      }
      [class*=PreviewPaneContainer-ControlPaneContainer] {
        padding: 0;
      }
      [class*=ControlPaneContainer] {
        max-width: 100vw;
      }
      [class*=EditorControlBar] [class*=ToolbarContainer] {
        display: flex;
        flex-direction: column;
      }
      [class*=CollectionContainer] {
        display: flex;
        flex-direction: column;
      }
      [class*=SidebarContainer] {
        position: initial;
        width: initial;
      }
      [class*=CollectionMain] {
        padding-left: 0;
        margin-top: 20px;
      }
    }
    </style>
  </body>
</html>
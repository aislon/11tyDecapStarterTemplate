<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Aislon Web Manager</title>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://aislon-cdn.pages.dev/cms/latest/aislon-decap-cms.js"></script> 
    <script src="netlify-identity-widget.js"></script>

    <script>
      // Function to inject custom CSS and JS
      function injectCustomResources() {
        // Inject CSS
        const cssLink = document.createElement('link');
        cssLink.rel = 'stylesheet';
        cssLink.href = 'https://aislon-cdn.pages.dev/cms/latest/aislon-decap-cms.css';
        document.head.appendChild(cssLink);

        // Inject JS
        const script = document.createElement('script');
        script.src = 'https://aislon-cdn.pages.dev/cms/latest/aislon-decap-cms.js';
        document.body.appendChild(script);
      }

      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => {
              document.location.href = "/admin/";
            });
          }
        });

        // Handle redirect after email confirmation
        window.netlifyIdentity.on("error", err => console.error("Netlify Identity error:", err));
        window.netlifyIdentity.on("login", () => {
          console.log("Logged in successfully");
          window.location.href = "/admin/#/";
        });
        window.netlifyIdentity.on("logout", () => {
          console.log("Logged out");
          window.location.href = "/";
        });
      }

      // Inject custom resources on page load
      injectCustomResources();

      // Observe changes in the CMS content and re-inject resources
      const observer = new MutationObserver(() => {
        injectCustomResources();
      });

      observer.observe(document.body, { childList: true, subtree: true });
    </script>

    <!-- Custom script to inject sidebar buttons -->
    <script>

      let ANALYTICS_URL = '/analytics';
      let SIDE_ID = 'custom-section';

      document.addEventListener('DOMContentLoaded', function() {
        function injectSidebarButtons() {
          const sidebarNav = document.querySelector('.css-kxvohc-SidebarNavList');
          
          if (!sidebarNav) {
            console.log('Sidebar nav not found, retrying...');
            return false;
          }

          if (document.querySelector('#custom-section')) {
            return true;
          }

          // Create custom section container
          const customSection = document.createElement('div');
          customSection.id = 'custom-section';
          customSection.style.marginTop = '8px';         // Added top margin
          customSection.style.marginBottom = '8px';      // Reduced from 12px
          customSection.style.paddingBottom = '8px';     // Reduced from 12px
          customSection.style.width = '100%';
          customSection.style.display = 'flex';

          // Create navigation container with proper styling
          const customNav = document.createElement('ul');
          customNav.className = 'css-kxvohc-SidebarNavList';
          customNav.style.width = '100%';
          customNav.style.display = 'flex';
          customNav.style.gap = '8px';
          customNav.style.padding = '0 12px';
          customNav.style.margin = '0';
          customNav.style.listStyle = 'none';

          // Create Analytics button with matching CMS styling
          const analyticsButton = document.createElement('li');
          analyticsButton.style.flex = '1';
          analyticsButton.innerHTML = `
            <a href="`+ ANALYTICS_URL +`" class="css-mt2v94-SidebarNavLink-sidebarNavLinkActive-SidebarNavLink" style="
              width: 100%;
              padding: 10px 12px;
              display: flex;
              align-items: center;
              font-size: 14px;
              color: #000;
              text-decoration: none;
              background-color: #f5f5f5;
              border-radius: 6px;
              transition: all 0.2s ease;
              height: 100%;
            ">
              <span class="e1jeq5dr0 css-5nxuzj-IconWrapper" style="margin-right: 8px;">
                <img src="/admin/media/analytic.svg" width="24" height="24" />
              </span>
              <span style="flex: 1;">Analytics</span>
            </a>`;

          // Create Site Info button with matching CMS styling
          const siteInfoButton = document.createElement('li');
          siteInfoButton.style.flex = '1';
          siteInfoButton.innerHTML = `
            <a href="/site-info" class="css-mt2v94-SidebarNavLink-sidebarNavLinkActive-SidebarNavLink" style="
              width: 100%;
              padding: 6px 12px;
              display: flex;
              align-items: center;
              font-size: 14px;
              color: #000;
              text-decoration: none;
              background-color: #f5f5f5;
              border-radius: 6px;
              transition: all 0.2s ease;
              height: 100%;
            ">
              <span class="e1jeq5dr0 css-5nxuzj-IconWrapper" style="margin-right: 8px;">
                <img src="/admin/media/info.svg" width="24" height="24" />
              </span>
              <span style="flex: 1;">Site Info</span>
            </a>`;

          // Add hover effect with JavaScript
          [analyticsButton, siteInfoButton].forEach(button => {
            const link = button.querySelector('a');
            link.addEventListener('mouseenter', () => {
              link.style.backgroundColor = '#e9e9e9';
            });
            link.addEventListener('mouseleave', () => {
              link.style.backgroundColor = '#f5f5f5';
            });
          });

          // Assemble section
          customNav.appendChild(analyticsButton);
          customNav.appendChild(siteInfoButton);
          customSection.appendChild(customNav);

          // Insert at the beginning of sidebar
          sidebarNav.parentNode.insertBefore(customSection, sidebarNav.parentNode.firstChild);

          return true;
        }

        let attempts = 0;
        const maxAttempts = 10;

        function tryInjectButtons() {
          if (attempts >= maxAttempts) return;
          
          if (!injectSidebarButtons()) {
            attempts++;
            setTimeout(tryInjectButtons, 1000);
          }
        }

        tryInjectButtons();
      });

      // Inject custom icon for user avatar
      document.addEventListener("DOMContentLoaded", function() {
          const targetNode = document.body;
          const config = { childList: true, subtree: true };

          const callback = function(mutationsList, observer) {
              for (const mutation of mutationsList) {
                  if (mutation.type === 'childList') {
                      const iconWrapper = document.querySelector(".css-16ibyj6-IconWrapper-AvatarPlaceholderIcon-avatarImage");
                      if (iconWrapper) {
                          const img = document.createElement("img");
                          img.src = "media/aislonHat.png"; // Replace with the path to your SVG image
                          img.width = 22;
                          img.height = 22;
                          img.style.margin = "auto";
                          img.style.display = "block";
                          iconWrapper.style.display = "flex";
                          iconWrapper.style.justifyContent = "center";
                          iconWrapper.style.alignItems = "center";
                          iconWrapper.innerHTML = "";
                          iconWrapper.appendChild(img);
                          observer.disconnect(); // Stop observing once the element is found and replaced
                          break;
                      }
                  }
              }
          };

          const observer = new MutationObserver(callback);
          observer.observe(targetNode, config);
      });
    </script>
  </body>
</html>